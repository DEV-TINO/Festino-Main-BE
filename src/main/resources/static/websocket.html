<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>함께 주문 테스트</title>
    <!-- STOMP 클라이언트 라이브러리 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .box { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; }
        .logs { height: 200px; overflow-y: scroll; background: #f5f5f5; padding: 10px; }
        button { padding: 5px 10px; margin-right: 5px; }
        .menu-item { display: flex; justify-content: space-between; align-items: center; padding: 5px; margin: 5px 0; border-bottom: 1px solid #eee; }
        .menu-count { font-weight: bold; margin: 0 10px; }
        .menu-buttons { display: flex; align-items: center; }
        .menu-btn { width: 30px; height: 30px; margin: 0 2px; }
    </style>
</head>
<body>
<h1>함께 주문 테스트</h1>

<div class="box">
    <h3>연결 설정</h3>
    <div>
        <label>서버 URL: <input type="text" id="serverUrl" value="ws://localhost:8080/ws"></label>
    </div>
    <div>
        <label>부스 ID: <input type="text" id="boothId"></label>
        <button id="generateBoothId">UUID 생성</button>
    </div>
    <div>
        <label>테이블 번호: <input type="number" id="tableNum" value="1"></label>
    </div>
    <div>
        <button id="connect">연결</button>
        <button id="disconnect" disabled>연결 해제</button>
    </div>
</div>

<div class="box" id="menuSection" style="display:none">
    <h3>메뉴 관리</h3>
    <div>
        <label>메뉴 ID: <input type="text" id="menuId"></label>
        <button id="generateMenuId">UUID 생성</button>
    </div>
    <div>
        <button id="addMenu">메뉴 추가(+)</button>
    </div>
</div>

<div class="box" id="menuListSection" style="display:none">
    <h3>주문 목록</h3>
    <div id="menuList"></div>
    <div>
        <p>참여자 수: <span id="memberCount">0</span>명</p>
        <p>총 수량: <span id="totalCount">0</span>개</p>
        <p>총 금액: <span id="totalPrice">0</span>원</p>
    </div>
</div>

<div class="box">
    <h3>로그</h3>
    <div class="logs" id="logArea"></div>
</div>

<script>
    // DOM 요소
    const serverUrlInput = document.getElementById('serverUrl');
    const boothIdInput = document.getElementById('boothId');
    const tableNumInput = document.getElementById('tableNum');
    const menuIdInput = document.getElementById('menuId');
    const connectBtn = document.getElementById('connect');
    const disconnectBtn = document.getElementById('disconnect');
    const generateBoothIdBtn = document.getElementById('generateBoothId');
    const generateMenuIdBtn = document.getElementById('generateMenuId');
    const addMenuBtn = document.getElementById('addMenu');
    const logArea = document.getElementById('logArea');
    const menuSection = document.getElementById('menuSection');
    const menuListSection = document.getElementById('menuListSection');
    const menuListDiv = document.getElementById('menuList');
    const memberCountSpan = document.getElementById('memberCount');
    const totalCountSpan = document.getElementById('totalCount');
    const totalPriceSpan = document.getElementById('totalPrice');

    // 메뉴 목록 (메뉴ID: 수량)
    const menus = {};

    // STOMP 클라이언트
    let stompClient = null;

    // 연결 여부 플래그
    let isConnected = false;

    // 로그 출력 함수
    function log(message) {
        const now = new Date().toLocaleTimeString();
        logArea.innerHTML += `<div>[${now}] ${message}</div>`;
        logArea.scrollTop = logArea.scrollHeight;
    }

    // UUID 생성 함수
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    // UUID 생성 버튼 이벤트
    generateBoothIdBtn.addEventListener('click', function() {
        boothIdInput.value = generateUUID();
    });

    generateMenuIdBtn.addEventListener('click', function() {
        menuIdInput.value = generateUUID();
    });

    // 연결 버튼 이벤트
    connectBtn.addEventListener('click', function() {
        const serverUrl = serverUrlInput.value;
        const boothId = boothIdInput.value;
        const tableNum = tableNumInput.value;

        if (!boothId) {
            alert('부스 ID를 입력하세요.');
            return;
        }

        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
        if (!uuidRegex.test(boothId)) {
            alert('올바른 형식의 UUID를 입력하세요.');
            return;
        }

        if (!tableNum) {
            alert('테이블 번호를 입력하세요.');
            return;
        }

        connect(serverUrl, boothId, tableNum);
    });

    // 연결 해제 버튼 이벤트
    disconnectBtn.addEventListener('click', function() {
        sendUnsubMessage();
        disconnect();
    });

    // 메뉴 추가 버튼 이벤트
    addMenuBtn.addEventListener('click', function() {
        const menuId = menuIdInput.value;

        if (!menuId) {
            alert('메뉴 ID를 입력하세요.');
            return;
        }

        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
        if (!uuidRegex.test(menuId)) {
            alert('올바른 형식의 UUID를 입력하세요.');
            return;
        }

        addMenu(menuId);
    });

    // 연결 함수
    function connect(serverUrl, boothId, tableNum) {
        log(`서버 연결 시도: ${serverUrl}`);

        // STOMP 클라이언트 생성
        stompClient = new StompJs.Client({
            brokerURL: serverUrl,
            debug: function(str) {
                console.log(str); // 디버그 정보는 콘솔에만 출력
            },
            reconnectDelay: 5000
        });

        // 연결 성공 콜백
        stompClient.onConnect = function() {
            isConnected = true;
            log('서버 연결 성공');

            // 버튼 상태 변경
            connectBtn.disabled = true;
            disconnectBtn.disabled = false;

            // 메뉴 관리 섹션 표시
            menuSection.style.display = 'block';
            menuListSection.style.display = 'block';

            // 메뉴 ID 자동 생성
            if (!menuIdInput.value) {
                menuIdInput.value = generateUUID();
            }

            // 토픽 구독
            const topic = `/topic/${boothId}/${tableNum}`;
            log(`토픽 구독: ${topic}`);

            stompClient.subscribe(topic, function(message) {
                handleMessage(message);
            });
        };

        // 연결 오류 콜백
        stompClient.onStompError = function(frame) {
            log(`서버 연결 오류: ${frame.headers.message}`);
        };

        // 연결 시작
        stompClient.activate();
    }

    // 구독 취소 메시지 전송
    function sendUnsubMessage() {
        if (stompClient && stompClient.connected) {
            const boothId = boothIdInput.value;
            const tableNum = tableNumInput.value;

            // 메시지 생성
            const message = {
                type: "UNSUB",
                boothId: boothId,
                tableNum: parseInt(tableNum)
            };

            // 메시지 전송
            stompClient.publish({
                destination: '/app/order',
                body: JSON.stringify(message)
            });

            log('구독 취소 메시지 전송');
        }
    }

    // 연결 해제 함수
    function disconnect() {
        if (stompClient && stompClient.connected) {
            stompClient.deactivate();
            isConnected = false;

            log('서버 연결 해제');

            // 버튼 상태 변경
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;

            // 메뉴 관리 섹션 숨김
            menuSection.style.display = 'none';
            menuListSection.style.display = 'none';

            // 메뉴 목록 초기화
            Object.keys(menus).forEach(key => delete menus[key]);
            updateMenuList();
        }
    }

    // 메뉴 추가 함수
    function addMenu(menuId) {
        if (stompClient && stompClient.connected) {
            const boothId = boothIdInput.value;
            const tableNum = tableNumInput.value;

            // 메시지 생성
            const message = {
                type: "MENUADD",
                boothId: boothId,
                tableNum: parseInt(tableNum),
                menuInfo: {
                    menuId: menuId,
                    menuCount: 0 // 서버에서 증가됨
                }
            };

            // 메시지 전송
            stompClient.publish({
                destination: '/app/order',
                body: JSON.stringify(message)
            });

            log(`메뉴 추가 요청: 메뉴ID=${menuId}`);
        }
    }

    // 메뉴 감소 함수
    function subMenu(menuId) {
        if (stompClient && stompClient.connected) {
            const boothId = boothIdInput.value;
            const tableNum = tableNumInput.value;

            // 메시지 생성
            const message = {
                type: "MENUSUB",
                boothId: boothId,
                tableNum: parseInt(tableNum),
                menuInfo: {
                    menuId: menuId,
                    menuCount: 0 // 서버에서 감소됨
                }
            };

            // 메시지 전송
            stompClient.publish({
                destination: '/app/order',
                body: JSON.stringify(message)
            });

            log(`메뉴 감소 요청: 메뉴ID=${menuId}`);
        }
    }

    // 메시지 처리 함수
    function handleMessage(message) {
        log(`메시지 수신: ${message.body}`);

        try {
            const data = JSON.parse(message.body);

            switch (data.type) {
                case "INIT":
                    handleInitMessage(data);
                    break;
                case "MENUUPDATE":
                    handleMenuUpdateMessage(data);
                    break;
                case "MEMBERUPDATE":
                    handleMemberUpdateMessage(data);
                    break;
                case "UNSUB":
                    handleUnsubMessage();
                    break;
                case "ERROR":
                    handleErrorMessage(data);
                    break;
                default:
                    log(`알 수 없는 메시지 타입: ${data.type}`);
            }
        } catch (e) {
            log(`메시지 처리 오류: ${e.message}`);
        }
    }

    // INIT 메시지 처리
    function handleInitMessage(data) {
        log(`초기화 정보 수신: 참여자=${data.initInfo.memberCount}명, 총수량=${data.initInfo.totalCount}개, 총금액=${data.initInfo.totalPrice}원`);

        // 메뉴 목록 초기화
        Object.keys(menus).forEach(key => delete menus[key]);

        // 메뉴 목록 설정
        if (data.initInfo.menuList && data.initInfo.menuList.length > 0) {
            data.initInfo.menuList.forEach(menu => {
                menus[menu.menuId] = menu.menuCount;
            });
        }

        // 상태 업데이트
        memberCountSpan.textContent = data.initInfo.memberCount;
        totalCountSpan.textContent = data.initInfo.totalCount;
        totalPriceSpan.textContent = data.initInfo.totalPrice;

        // 메뉴 목록 업데이트
        updateMenuList();
    }

    // MENUUPDATE 메시지 처리
    function handleMenuUpdateMessage(data) {
        log(`메뉴 업데이트: 메뉴ID=${data.menuInfo.menuId}, 수량=${data.menuInfo.menuCount}`);

        // 메뉴 정보 업데이트
        menus[data.menuInfo.menuId] = data.menuInfo.menuCount;

        // 메뉴 목록 업데이트
        updateMenuList();
    }

    // MEMBERUPDATE 메시지 처리
    function handleMemberUpdateMessage(data) {
        log(`참여자 업데이트: ${data.memberInfo.memberCount}명`);
        memberCountSpan.textContent = data.memberInfo.memberCount;
    }

    // UNSUB 메시지 처리
    function handleUnsubMessage() {
        log('구독 취소 메시지 수신');
        disconnect();
    }

    // ERROR 메시지 처리
    function handleErrorMessage(data) {
        log(`오류 메시지: ${data.errorMessage}`);
    }

    // 메뉴 목록 업데이트
    function updateMenuList() {
        menuListDiv.innerHTML = '';

        const menuIds = Object.keys(menus);

        if (menuIds.length === 0) {
            menuListDiv.innerHTML = '<div>주문한 메뉴가 없습니다.</div>';
            return;
        }

        menuIds.forEach(menuId => {
            const count = menus[menuId];
            const item = document.createElement('div');
            item.className = 'menu-item';

            const shortId = menuId.split('-')[0]; // UUID의 첫 부분만 표시

            item.innerHTML = `
                <span>메뉴 ID: ${shortId}...</span>
                <div class="menu-buttons">
                    <button class="menu-btn" onclick="subMenu('${menuId}')" ${count <= 0 ? 'disabled' : ''}>-</button>
                    <span class="menu-count">${count}</span>
                    <button class="menu-btn" onclick="addMenu('${menuId}')">+</button>
                </div>
            `;

            menuListDiv.appendChild(item);
        });
    }

    // 페이지 로드 시 UUID 자동 생성
    window.addEventListener('load', function() {
        boothIdInput.value = generateUUID();
        menuIdInput.value = generateUUID();
    });

    // 페이지 닫기/뒤로 가기 이벤트
    window.addEventListener('beforeunload', function(e) {
        if (isConnected) {
            // 구독 취소 메시지 전송
            sendUnsubMessage();

            // 모던 브라우저에서는 사용자 정의 메시지가 표시되지 않지만,
            // 일부 브라우저에서는 이 메시지가 표시될 수 있습니다.
            e.returnValue = '정말 페이지를 떠나시겠습니까? 주문이 취소됩니다.';
            return e.returnValue;
        }
    });

    // 전역 함수로 노출
    window.addMenu = addMenu;
    window.subMenu = subMenu;
    window.sendUnsubMessage = sendUnsubMessage;
</script>
</body>
</html>